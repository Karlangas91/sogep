<%- include('../partials/header') %>
<%- include('../partials/sidebar') %>

<div class="content-wrapper">
    <section class="content-header">
        <h1>Gestión de Clientes</h1>
    </section>

    <section class="content">
        <!-- Botón para abrir el modal -->
        <button id="openModalBtn" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#clientModal">Agregar Nuevo Cliente</button>

        <!-- Tabla de Clientes -->
        <br>
        <table class="table table-bordered" id="clientesTable">
            <thead>
                <tr>
                    <th>Código</th>
                    <th>Nombre Comercial</th>
                    <th>Cédula</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <% clients.forEach(client => { %>
                    <tr>
                        <td><%= client.codigo %></td>
                        <td><%= client.nombre_comercial %></td>
                        <td><%= client.cedula %></td>
                        <td><%= client.estado %></td>
                        <td>
                            <!-- Aquí puedes agregar botones para editar o eliminar -->
                            <a href="/clients/edit/<%= client.id %>" class="btn btn-warning btn-sm">Editar</a>
                            <a href="/clients/delete/<%= client.id %>" class="btn btn-danger btn-sm">Eliminar</a>
                        </td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    </section>
</div>

<%- include('../partials/footer') %>

<!-- Modal de creación de cliente -->
<div class="modal fade" id="clientModal" tabindex="-1" aria-labelledby="clientModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="clientModalLabel">Agregar Nuevo Cliente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Formulario dentro del modal -->
        <form id="createClientForm">
            <div class="form-group">
                <label for="codigo">Código:</label>
                <input type="text" id="codigo" name="codigo" class="form-control" pattern="\d*" title="Solo se permiten números" required>
            </div>
            <div class="form-group">
                <label for="nombre_comercial">Nombre Comercial:</label>
                <input type="text" id="nombre_comercial" name="nombre_comercial" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="razon_social">Razón Social:</label>
                <input type="text" id="razon_social" name="razon_social" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="cedula">Cédula:</label>
                <input type="text" id="cedula" name="cedula" class="form-control" pattern="\d*" title="Solo se permiten números" required>
            </div>
            <div class="form-group">
                <label for="direccion_oficina">Dirección Oficina:</label>
                <input type="text" id="direccion_oficina" name="direccion_oficina" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="direccion_entrega1">Dirección de Entrega 1:</label>
                <input type="text" id="direccion_entrega1" name="direccion_entrega1" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="direccion_entrega2">Dirección de Entrega 2:</label>
                <input type="text" id="direccion_entrega2" name="direccion_entrega2" class="form-control">
            </div>
            <div class="form-group">
                <label for="plazo_credito">Plazo de Crédito:</label>
                <input type="number" id="plazo_credito" name="plazo_credito" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="estado">Estado:</label>
                <select id="estado" name="estado" class="form-control" required>
                    <option value="Activo">Activo</option>
                    <option value="Inactivo">Inactivo</option>
                </select>
            </div>
            <div class="form-group">
                <label for="vendedor">Vendedor:</label>
                <input type="text" id="vendedor" name="vendedor" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="asistente">Asistente:</label>
                <input type="text" id="asistente" name="asistente" class="form-control" required>
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="saveClientBtn">Guardar Cliente</button>
      </div>
    </div>
  </div>
</div>

<!-- Cargar Bootstrap 5 JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Código JavaScript para manejar la creación de cliente -->
<script>
    // Este código ya no necesita jQuery, ya que Bootstrap 5 maneja los modales con los atributos de datos
    // El modal ahora se controla a través de los atributos data-bs-toggle y data-bs-target

    // Al hacer clic en el botón "Agregar Nuevo Cliente", el modal se abrirá automáticamente
    document.getElementById('openModalBtn').addEventListener('click', function () {
        var myModal = new bootstrap.Modal(document.getElementById('clientModal'), {
            keyboard: false
        });
        myModal.show();
    });

    // Manejo de la creación del cliente
    document.getElementById('saveClientBtn').addEventListener('click', function () {
        var formData = new FormData(document.getElementById('createClientForm'));  // Usamos FormData para capturar los datos del formulario

        fetch('/clients/create', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);  // Muestra el mensaje de éxito
            var newClient = data.client;  // Suponiendo que el servidor devuelve el cliente recién creado

            // Añadir la nueva fila a la tabla sin recargar la página
            var table = document.getElementById('clientesTable').getElementsByTagName('tbody')[0];
            var row = table.insertRow();
            row.innerHTML = `
                <td>${newClient.codigo}</td>
                <td>${newClient.nombre_comercial}</td>
                <td>${newClient.cedula}</td>
                <td>${newClient.estado}</td>
                <td>
                    <a href="/clients/edit/${newClient.id}" class="btn btn-warning btn-sm">Editar</a>
                    <a href="/clients/delete/${newClient.id}" class="btn btn-danger btn-sm">Eliminar</a>
                </td>
            `;

            // Cerrar el modal
            var myModal = bootstrap.Modal.getInstance(document.getElementById('clientModal'));
            myModal.hide();
        })
        .catch(error => {
            alert('Hubo un error al crear el cliente');
        });
    });
</script>
